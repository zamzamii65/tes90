<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Sapi Terbang untuk Trisha üíñ</title>
  <style>
    body {
      margin:0;
      overflow:hidden;
      background:#000;
      display:flex;
      justify-content:center;
      align-items:center;
      height:100vh;
      flex-direction: column;
      font-family: Arial, sans-serif;
      position: relative;
    }
    canvas {
      display:none;
      border:2px solid black;
    }
    #restartBtn {
      display:none;
      margin-top:20px;
      padding:10px 20px;
      font-size:18px;
      border:none;
      background:#ff4444;
      color:white;
      border-radius:8px;
      cursor:pointer;
      position:absolute;
      left:50%;
      transform:translateX(-50%);
    }
    #restartBtn:hover { background:#cc0000; }

    #startScreen {
      color:white;
      font-size:24px;
      text-align:center;
    }
    .char-select {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }
    .char-select img {
      width: 90px;
      height: 90px;
      cursor: pointer;
      border: 3px solid transparent;
      border-radius: 10px;
      transition: 0.2s;
    }
    .char-select img:hover {
      border: 3px solid yellow;
      transform: scale(1.1);
    }

    /* GIF Game Over */
    #gameOverGif {
      display: none;
      position: absolute;
      top: 53%;
      left: 50%;
      transform: translate(-50%, -130%);
      width: 100px;
      height: auto;
      z-index: 10;
    }

    /* Modal background */
    .modal {
      display: none; 
      position: fixed; 
      z-index: 1000; 
      left: 0; 
      top: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.7); 
      justify-content: center; 
      align-items: center;
      animation: fadeIn 0.4s ease;
    }
    .modal-content {
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      max-width: 400px;
      width: 80%;
      box-shadow: 0px 5px 15px rgba(0,0,0,0.3);
      animation: scaleUp 0.3s ease;
    }
    .modal-content h2 {
      margin: 0 0 15px;
      font-size: 28px;
      color: #44dd44;
    }
    .modal-content p {
      font-size: 18px;
      margin-bottom: 20px;
    }
    .modal-content button {
      padding: 10px 20px;
      font-size: 18px;
      background: #44aa44;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    .modal-content button:hover { background: #228822; }
  </style>
</head>
<body>

  <!-- GIF Game Over -->
  <img id="gameOverGif" src="over.gif">

  <!-- Pilih Karakter -->
  <div id="startScreen">
    <h1>Pilih Karakter Sapi üêÑ‚ú®</h1>
    <div class="char-select">
      <img src="cover_sapi1.jpg" data-sprite="sapi1.png">
      <img src="cover_sapi2.jpg" data-sprite="sapi2.png">
      <img src="cover_sapi3.jpg" data-sprite="sapi3.png">
      <img src="cover_sapi4.jpg" data-sprite="sapi4.png">
    </div>
  </div>

  <!-- Game -->
  <canvas id="gameCanvas" width="600" height="400"></canvas>
  <button id="restartBtn">üîÑ Restart</button>

  <!-- Modal Kemenangan -->
  <div id="winModal" class="modal">
    <div class="modal-content">
      <h2>üéâ Selamat! üéâ</h2>
      <p>Kamu berhasil nangkep 10 balon buat Trisha! üéàüêÑ‚ú®</p>
      <button id="closeWinBtn">OK</button>
    </div>
  </div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const restartBtn = document.getElementById("restartBtn");
    const startScreen = document.getElementById("startScreen");
    const winModal = document.getElementById("winModal");
    const gameOverGif = document.getElementById("gameOverGif");

    let WIDTH = canvas.width;
    let HEIGHT = canvas.height;

    let sprite = new Image();
    const bg = new Image();
    bg.src = "background.png";

    // AUDIO
    const bgm = new Audio("backsound.mp3");
    const loseSfx = new Audio("lose.mp3");
    const winSfx = new Audio("win.mp3");
    const cowSfx = new Audio("moo.mp3");

    bgm.loop = true;
    bgm.volume = 0.5;
    cowSfx.volume = 0.6;

    const frameWidth = 64;
    const frameHeight = 64;
    let currentFrame = 0;

    let cow, pipes, balloons, score, gameOver, finished;
    let gameLoopId;
    let targetScore = 10;
    let cowSfxInterval;
    let deathReason = "";

    // === Resize Canvas Supaya Responsive ===
    function resizeCanvas() {
      let newWidth = Math.min(window.innerWidth * 0.9, 600);
      let newHeight = newWidth * (400 / 600);

      canvas.width = newWidth;
      canvas.height = newHeight;

      WIDTH = newWidth;
      HEIGHT = newHeight;
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    function resetGame() {
      cow = {
        x: WIDTH / 6,
        y: HEIGHT / 2,
        width: frameWidth,
        height: frameHeight,
        gravity: 0.6,
        lift: -10,
        velocity: 0,
        tick: 0
      };
      pipes = [];
      balloons = [];
      score = 0;
      gameOver = false;
      finished = false;
      deathReason = "";
      restartBtn.style.display = "none";
      restartBtn.innerText = "üîÑ Restart";
      gameOverGif.style.display = "none";

      if (cowSfxInterval) clearInterval(cowSfxInterval);
      cowSfxInterval = setInterval(() => {
        const sfx = cowSfx.cloneNode(true);
        sfx.play();
      }, 4000);
    }

    document.addEventListener("keydown", (e) => {
      if (e.code === "Space" && !gameOver && !finished) {
        cow.velocity = cow.lift;
      }
    });
    canvas.addEventListener("touchstart", () => {
      if (!gameOver && !finished) {
        cow.velocity = cow.lift;
      }
    });

    let pipeWidth = 80;
    let gap = 200;
    let pipeSpeed = 2.5;
    let pipeDistance = 350;

    function update() {
      if (gameOver || finished) return;

      cow.velocity += cow.gravity;
      cow.y += cow.velocity;

      if (cow.y + cow.height >= HEIGHT) {
        deathReason = "fall";
        endGame();
      }
      if (cow.y < 0) cow.y = 0;

      cow.tick++;
      if (cow.tick % 8 === 0) {
        currentFrame = (currentFrame + 1) % 4;
      }

      for (let i = 0; i < pipes.length; i++) {
        pipes[i].x -= pipeSpeed;
      }
      balloons.forEach(b => b.x -= pipeSpeed);

      // tabrakan sapi dengan pipa
      for (let i = 0; i < pipes.length; i++) {
        if (
          cow.x < pipes[i].x + pipeWidth &&
          cow.x + cow.width > pipes[i].x &&
          (cow.y < pipes[i].y || cow.y + cow.height > pipes[i].y + gap)
        ) {
          deathReason = "hit";
          endGame();
        }
      }

      // tabrakan sapi dengan balon
      balloons.forEach(b => {
        if (!b.collected &&
          cow.x < b.x + b.size &&
          cow.x + cow.width > b.x - b.size &&
          cow.y < b.y + b.size &&
          cow.y + cow.height > b.y - b.size) {
          score++;
          b.collected = true;

          if (score >= targetScore) {
            finishGame();
          }
        }
      });

      pipes = pipes.filter(pipe => pipe.x + pipeWidth > 0);
      balloons = balloons.filter(b => b.x + b.size > 0);

      if (pipes.length === 0 || pipes[pipes.length - 1].x < WIDTH - pipeDistance) {
        let pipeY = Math.floor(Math.random() * (HEIGHT - gap - 50)) + 25;
        pipes.push({ x: WIDTH, y: pipeY, passed: false });
        balloons.push({
          x: WIDTH + pipeWidth/2,
          y: pipeY + gap/2,
          size: 30,
          collected: false
        });
      }
    }

    function endGame() {
      if (gameOver) return;
      gameOver = true;

      bgm.pause();
      bgm.currentTime = 0;
      clearInterval(cowSfxInterval);

      const sfx = loseSfx.cloneNode(true);
      sfx.play();

      restartBtn.style.display = "block";
      restartBtn.style.top = (canvas.offsetTop + HEIGHT/2 + 80) + "px";

      gameOverGif.style.display = "block";
    }

    function finishGame() {
      finished = true;
      gameOver = true;

      clearInterval(cowSfxInterval);

      restartBtn.style.display = "block";
      restartBtn.innerText = "Main Lagi üîÑ";

      bgm.pause();
      bgm.currentTime = 0;
      winSfx.currentTime = 0;
      winSfx.play();

      winModal.style.display = "flex";
    }

    function draw() {
      ctx.drawImage(bg, 0, 0, WIDTH, HEIGHT);

      ctx.drawImage(
        sprite,
        currentFrame * frameWidth, 0, frameWidth, frameHeight,
        cow.x, cow.y, cow.width, cow.height
      );

      ctx.fillStyle = "green";
      for (let i = 0; i < pipes.length; i++) {
        ctx.fillRect(pipes[i].x, 0, pipeWidth, pipes[i].y);
        ctx.fillRect(pipes[i].x, pipes[i].y + gap, pipeWidth, HEIGHT);
      }

      // gambar balon
      balloons.forEach(b => {
        if (!b.collected) {
          ctx.font = b.size + "px Arial";
          ctx.textAlign = "center";
          ctx.fillText("üéà", b.x, b.y);
        }
      });

      ctx.fillStyle = "black";
      ctx.font = "24px Arial";
      ctx.fillText("Score: " + score, 55, 40);

      if (gameOver && !finished) {
        ctx.fillStyle = "rgba(0,0,0,0.6)";
        ctx.fillRect(0, 0, WIDTH, HEIGHT);

        ctx.fillStyle = "red";
        ctx.font = "40px Arial";
        ctx.textAlign = "center";
        ctx.fillText("GAME OVER", WIDTH/2, HEIGHT/2 + 30);

        ctx.fillStyle = "white";
        ctx.font = "22px Arial";
        if (deathReason === "fall") {
          ctx.fillText("Dedek Trisha Jatuh ü•∫", WIDTH/2, HEIGHT/2 + 60);
        } else if (deathReason === "hit") {
          ctx.fillText("Dedek Trisha Nabrak üò≠", WIDTH/2, HEIGHT/2 + 60);
        }

        ctx.textAlign = "start";
      }
    }

    function gameLoop() {
      update();
      draw();
      gameLoopId = requestAnimationFrame(gameLoop);
    }

    restartBtn.addEventListener("click", () => {
      cancelAnimationFrame(gameLoopId);
      restartBtn.style.display = "none";
      canvas.style.display = "none";
      startScreen.style.display = "block";
      gameOverGif.style.display = "none";
    });

    document.getElementById("closeWinBtn").addEventListener("click", () => {
      winModal.style.display = "none";
    });

    document.querySelectorAll(".char-select img").forEach(img => {
      img.addEventListener("click", () => {
        cancelAnimationFrame(gameLoopId);
        let chosen = img.getAttribute("data-sprite");
        sprite = new Image();
        sprite.src = chosen;

        startScreen.style.display = "none";
        canvas.style.display = "block";
        resetGame();

        bgm.currentTime = 0;
        bgm.play().catch(err => {
          console.log("Autoplay dicegah browser", err);
        });

        sprite.onload = () => {
          gameLoop();
        };
      });
    });
  </script>
</body>
</html>
